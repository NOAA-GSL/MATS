SELECT m.name AS sta_id,\n       ARRAY_MIN(stats[*].fve) AS min_secs,\n       ARRAY_MAX(stats[*].fve) AS max_secs,\n       ARRAY_SUM(stats [*].hit) AS hits,\n       ARRAY_SUM(stats [*].miss) AS misses,\n       ARRAY_SUM(stats [*].false_alarm) AS fa,\n       ARRAY_SUM(stats [*].correct_negative) AS cn,\n       ARRAY_SUM(stats [*].total) AS N0,\n       ARRAY_COUNT(ARRAY_DISTINCT(stats[*].fve)) AS N_times,\n       ARRAY_SORT(stats[*].sub) AS sub_data\nFROM (\n    SELECT sdu.name AS name,\n           ARRAY_AGG(sdu) AS data\n    FROM (\n        SELECT stationData\n        FROM vxdata._default.METAR AS obs\n        LET ofve = obs.fcstValidEpoch,\n            stationData = ARRAY OBJECT_ADD(d, 'ofve', ofve ) FOR d IN ( [obs.data.KAPA,obs.data.KBDU,obs.data.KBJC,obs.data.KBKF,obs.data.KCFO,obs.data.KDEN,obs.data.KEIK,obs.data.KLMO] ) END\n        WHERE type = \"DD\"\n            AND docType = \"obs\"\n            AND version = \"V01\"\n            AND obs.fcstValidEpoch BETWEEN 1668272400 AND 1670864400 ) sd\n    UNNEST sd.stationData sdu\n    GROUP BY sdu.name\n    ORDER BY sdu.name) o,\n(\n    SELECT sdu.name AS name,\n           ARRAY_AGG(sdu) AS data\n    FROM (\n        SELECT modelData\n        FROM vxdata._default.METAR AS models\n        LET mfve = models.fcstValidEpoch,\n            modelData = ARRAY OBJECT_ADD(d, 'mfve', mfve ) FOR d IN ( [models.data.KAPA,models.data.KBDU,models.data.KBJC,models.data.KBKF,models.data.KCFO,models.data.KDEN,models.data.KEIK,models.data.KLMO] ) END\n        WHERE type = \"DD\"\n            AND docType = \"model\"\n            AND model = \"RAP_OPS_130\"\n            AND fcstLen = 6\n            AND version = \"V01\"\n            AND models.fcstValidEpoch BETWEEN 1668272400 AND 1670864400) sd\n    UNNEST sd.modelData sdu\n    GROUP BY sdu.name\n    ORDER BY sdu.name) m\nLET stats = ARRAY( FIRST { 'hit' :CASE WHEN mv.Ceiling < 500.0\n        AND ov.Ceiling < 500.0 THEN 1 ELSE 0 END,\n                                          'miss' :CASE WHEN NOT mv.Ceiling < 500.0\n        AND ov.Ceiling < 500.0 THEN 1 ELSE 0 END,\n                                          'false_alarm' :CASE WHEN mv.Ceiling < 500.0\n        AND NOT ov.Ceiling < 500.0 THEN 1 ELSE 0 END,\n                                              'correct_negative' :CASE WHEN NOT mv.Ceiling < 500.0\n        AND NOT ov.Ceiling < 500.0 THEN 1 ELSE 0 END,\n                                              'total' :CASE WHEN mv.Ceiling IS NOT MISSING\n        AND ov.Ceiling IS NOT MISSING THEN 1 ELSE 0 END,\n                                                'fve': mv.mfve,\n                                                'sub': TO_STRING(mv.mfve) || ';' || CASE WHEN mv.Ceiling < 500.0\n        AND ov.Ceiling < 500.0 THEN '1' ELSE '0' END || ';' || CASE WHEN mv.Ceiling < 500.0\n        AND NOT ov.Ceiling < 500.0 THEN '1' ELSE '0' END || ';' || CASE WHEN NOT mv.Ceiling < 500.0\n        AND ov.Ceiling < 500.0 THEN '1' ELSE '0' END || ';' || CASE WHEN NOT mv.Ceiling < 500.0\n        AND NOT ov.Ceiling < 500.0 THEN '1' ELSE '0' END } FOR ov IN o.data WHEN ov.ofve = mv.mfve\n        AND ov.name = mv.name END ) FOR mv IN m.data END\nWHERE m.name = o.name